from os import listdir
import os
from os.path import isfile, join
import json
import pandas as pd
import numpy as np


# Get Count for particular attribute in Json object
def get_count(_summary, attribute):
    cnt = 0
    if attribute in _summary:
        cnt = len(_summary[attribute])
    return cnt


# returns list with count of files read/written/deleted, etc.
def get_list(_summary):
    return [get_count(_summary, 'file_created'), get_count(_summary, 'file_deleted'),
            get_count(_summary, 'file_written'),
            get_count(_summary, 'directory_created'), get_count(_summary, 'regkey_opened'),
            get_count(_summary, 'dll_loaded'), get_count(_summary, 'resolves_host')]


# Create and returns features list for using json files in folder
def get_features(path):
    # For Extracting information about files
    features = []

    # Debugging purpose
    counter = 0

    # Get all the files in current path
    all_files = [join(path, f) for f in listdir(path) if isfile(join(path, f))]
    for file in all_files:

        # Debugging purposes
        counter += 1
        if counter % 100 == 0:
            print(str(counter)+'\n')

        with open(file) as f:
            data = json.load(f)
        # row variable will contain feature representation of current file
        row = []
        if 'summary' in data['behavior']:
            summary = data['behavior']['summary']
            # Add current file details to features list
            row = get_list(summary)
            '''
            # To get DLLs as feature
            main_file = open(curr_file, 'a')
            for val in row:
                main_file.write(str(val) + ',')
            main_file.write('\n')
            main_file.close()
            '''
            if 'dll_loaded' in summary:
                # Strip path (prefix) , '.dll' (suffix) and convert dll name to lowercase
                # Also create set, so no dll is counted more than once
                dll_set = set([dll.split('\\')[-1].split('/')[-1].lower() for dll in summary['dll_loaded']])
                dll_dict = c = dict.fromkeys(dll_set, 0)
                for dll in dll_names:
                    if dll in dll_dict:
                        row.append(1)
                    else:
                        row.append(0)
                '''
                # To get DLLs as feature
                # Update dll_map count
                for dll in dll_set:
                    if dll.endswith('.dll'):
                        # curr_dll_set.update([dll])
                        if dll in dll_map:
                            dll_map[dll] += 1
                        else:
                            dll_map[dll] = 1
                '''
            else:
                for dll in dll_names:
                    row.append(0)
        # Add Virus Total positives as feature
        if 'virustotal' in data:
            virustotal = data['virustotal']
            if 'positives' in virustotal:
                row.append(virustotal['positives'])
            else:
                row.append(0)
        else:
            row.append(0)
        # Append this row in main list of features
        features.append(row)
    return features


def save_to_file(param, features):
    df = pd.DataFrame({
        'Benign/Malware': np.zeros(features.shape[0]) if param == 0 else np.ones(features.shape[0]),
        '#FilesCreated': features[:, 0],
        '#FilesDeleted': features[:, 1],
        '#FilesWritten': features[:, 2],
        '#DirCreated': features[:, 3],
        '#RegKeyOpened': features[:, 4],
        '#DLLsImported': features[:, 5],
        '#URLsResolved': features[:, 6],
    })
    features = np.delete(features, [0, 1, 2, 3, 4, 5, 6], axis=1)
    df2 = pd.DataFrame(features)
    df = pd.concat([df, df2], axis=1)
    df.to_csv('Features\\benign.csv' if param == 0 else 'Features\\malware.csv', index=False)


def remove_csv_files():
    current_dir = os.getcwd()
    file_list = [f for f in os.listdir(current_dir+'\\Features') if f.endswith(".csv")]
    for f in file_list:
        os.remove(os.path.join(current_dir+'\\Features', f))


def get_dll_feature(min_count):
    names = np.array(pd.read_csv('Constants\\Dll_Features.csv'))
    count_dll = names[:, [1]]
    name_dll = names[:, [0]]
    condition = count_dll >= min_count
    names = name_dll[condition]
    return names


'''
# Feature List representation
1. Benign/Malware -> 0/1
2. #FilesCreated -> count
3. #FilesDeleted -> count
4. #FilesWritten -> count
5. #DirCreated -> count
6. #RegKeyOpened -> count
7. #DLLsImported -> count
8...n-1 DLL name -> 0/1
n. VirusTotal positives -> count
'''

# Main Stars Here
# Global Variables
dll_map = {}
folder_path = 'C:\\Users\JAYU\Desktop\IIT Kanpur MTech\SEM 2\Malware\Mid-Term-Data\Data\Dynamic_Analysis_RAWDATA\Dynamic_Analysis_RAWDATA\\'

'''
# For Debugging purpose
folder_path = 'C:\\Users\JAYU\Desktop\IIT Kanpur MTech\SEM 2\Malware\Mid-Term-Data\Data\Dynamic_Analysis_RAWDATA\Dummy\\'
curr_file = 'benign_file.csv'
'''

# Remove OLD csv files
remove_csv_files()

# Consider only good dll as features
min_dll_count = 10
dll_names = get_dll_feature(min_dll_count)
# Get Features for Benign
benign_features = np.array(get_features(folder_path + 'Benign'))
# Save the Benign Feature
save_to_file(0, benign_features)

'''
# To Get DLLs as features 
# Save Count of DLL for benign
dll_map_benign = dict(sorted(dll_map.items(), key=operator.itemgetter(1), reverse=True))
with open('DLL_Map_Benign.csv', 'w') as dll_file:
    for key in dll_map_benign.keys():
        dll_file.write("%s,%d\n" % (key, dll_map_benign[key]))

benign_dll_set = set(dll_map_benign.keys())

curr_file = 'malware_file.csv'
dll_map.clear()
'''
# Get Features for Malware
malware_backdoor = np.array(get_features(folder_path + 'Malware\Backdoor\\'))
malware_trojan = np.array(get_features(folder_path + 'Malware\Trojan\\'))
malware_trojan_downloader = np.array(get_features(folder_path + 'Malware\TrojanDownloader\\'))
malware_trojan_dropper = np.array(get_features(folder_path + 'Malware\TrojanDropper\\'))
malware_virus = np.array(get_features(folder_path + 'Malware\Virus\\'))
malware_worm = np.array(get_features(folder_path + 'Malware\Worm\\'))

'''
# To Get DLLs as features
dll_map_malware = dict(sorted(dll_map.items(), key=operator.itemgetter(1), reverse=True))
with open('DLL_Map_Malware.csv', 'w') as dll_file:
    for key in dll_map_malware.keys():
        dll_file.write("%s,%d\n" % (key, dll_map_malware[key]))

malware_dll_set = set(dll_map_malware.keys())

total_dll_features = (benign_dll_set - malware_dll_set) | (malware_dll_set - benign_dll_set)

with open('benign_dll_set.csv', 'w') as ff:
    for item in benign_dll_set:
        ff.write("%s\n" % item)
with open('malware_dll_set.csv', 'w') as ff:
    for item in malware_dll_set:
        ff.write("%s\n" % item)
with open('total_dll_features.csv', 'w') as ff:
    for item in total_dll_features:
        ff.write("%s\n" % item)
'''

# Merge all malware feature into single feature list
malware_features = np.concatenate(
    (malware_backdoor, malware_trojan, malware_trojan_downloader, malware_trojan_dropper, malware_virus, malware_worm))

# Save the Malware Feature
save_to_file(1, malware_features)
